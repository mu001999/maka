# 系统架构文档

## 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                    前端层 (React + TypeScript)               │
│  ┌─────────────────┐    ┌─────────────────┐    ┌────────────┐ │
│  │   App.tsx       │    │   Components    │    │   D3.js    │ │
│  │   - 状态管理     │    │   - 旭日图       │    │   - 可视化  │ │
│  │   - 事件处理     │    │   - 树状图       │    │   - 图表    │ │
│  │   - 数据流       │    │   - 控制面板     │    │   - 交互    │ │
│  └────────┬────────┘    └────────┬────────┘    └─────┬──────┘ │
│           │                     │                   │        │
│           └─────────────────────┼───────────────────┘        │
│                                 │                            │
│  ┌──────────────────────────────┴────────────────────────────┐ │
│  │              Tauri 桥接层 (IPC 通信)                        │ │
│  │  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐ │ │
│  │  │  invoke()    │    │  event emit  │    │  error handle│ │ │
│  │  │  命令调用      │    │  事件传递      │    │  错误处理     │ │ │
│  │  └────────┬─────┘    └──────┬───────┘    └──────┬───────┘ │ │
│  │           │                  │                    │         │ │
│  │           └──────────────────┼────────────────────┘         │ │
│  │                              │                             │ │
│  └──────────────────────────────┴─────────────────────────────┘ │
│                                 │                            │
└─────────────────────────────────┼────────────────────────────┘
                                  │
┌─────────────────────────────────┼────────────────────────────┐
│                    后端层 (Rust + Tauri)                     │
│  ┌──────────────────────────────┴─────────────────────────────┐ │
│  │                 核心服务层                                     │ │
│  │  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐ │ │
│  │  │  main.rs     │    │  permissions  │    │  error handle│ │ │
│  │  │  - 命令定义    │    │  - 权限管理     │    │  - 错误处理     │ │ │
│  │  │  - 路由配置    │    │  - 安全检查     │    │  - 日志记录     │ │ │
│  │  └──────┬───────┘    └──────┬────────┘    └──────┬───────┘ │ │
│  │         │                    │                    │         │ │
│  │         └────────────────────┼────────────────────┘         │ │
│  │                                │                           │ │
│  │  ┌──────────────────────────────┴─────────────────────────────┐ │ │
│  │  │              磁盘扫描器 (disk_scanner.rs)                  │ │ │
│  │  │  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐ │ │ │
│  │  │  │  Directory   │    │  File Entry  │    │  Cache       │ │ │ │
│  │  │  │  - 目录结构    │    │  - 文件信息     │    │  - 缓存机制   │ │ │ │
│  │  │  │  - 递归扫描    │    │  - 大小计算     │    │  - 性能优化   │ │ │ │
│  │  │  │  - 并行处理    │    │  - 类型判断     │    │  - 数据存储   │ │ │ │
│  │  │  └──────────────┘    └──────────────┘    └──────────────┘ │ │ │
│  │  └────────────────────────────────────────────────────────────┘ │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                 │                            │
│  ┌──────────────────────────────┴─────────────────────────────┐ │
│  │                系统接口层                                     │ │
│  │  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐ │ │
│  │  │  File System │    │  System Info  │    │  Path Utils  │ │ │
│  │  │  - 文件操作     │    │  - 系统信息     │    │  - 路径处理   │ │ │
│  │  │  - 权限检查     │    │  - 驱动器枚举   │    │  - 路径解析   │ │ │
│  │  │  - 元数据读取   │    │  - 平台检测     │    │  - 路径标准化 │ │ │
│  │  └──────────────┘    └──────────────┘    └──────────────┘ │ │
│  └──────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────┘
```

## 核心模块说明

### 1. 前端模块 (src/)

#### App.tsx
- **职责**: 主应用组件，状态管理中心
- **功能**: 
  - 管理应用状态 (currentData, loading, error)
  - 处理用户交互事件
  - 协调组件间通信
  - 调用后端命令

#### Components/
- **SunburstChart.tsx**: 旭日图可视化组件
  - 层级数据展示
  - 交互式导航
  - 动态渲染
- **TreemapChart.tsx**: 树状图可视化组件
  - 空间占比展示
  - 颜色编码
  - 悬停效果

### 2. 后端模块 (src-tauri/src/)

#### main.rs
- **职责**: Tauri 应用入口和命令定义
- **命令**:
  - `get_system_drives`: 获取系统驱动器
  - `build_directory_cache`: 构建目录缓存
  - `get_directory_children_with_depth`: 获取指定深度的子目录内容
  - `get_error_stats`: 获取错误统计
  - `reset_error_stats`: 重置错误统计
  - `request_disk_access`: 请求磁盘访问权限
  - `select_directory`: 选择目录

#### disk_scanner.rs
- **核心结构**:
  ```rust
  pub struct DiskScanner {
      cache: Arc<Mutex<HashMap<String, Vec<FileInfo>>>>,
  }
  
  pub struct FileInfo {
      pub name: String,
      pub path: String,
      pub size: u64,
      pub is_directory: bool,
      pub children: Option<Vec<FileInfo>>,
  }
  ```

- **关键功能**:
  - 并行目录扫描 (使用 `rayon`)
  - 智能缓存机制
  - 系统目录过滤
  - 错误处理和重试

#### permissions.rs
- **职责**: 系统权限管理
- **功能**:
  - 文件系统访问权限检查
  - 权限请求处理
  - 安全策略验证

## 数据流设计

### 1. 初始化流程
```
前端启动 → 获取系统驱动器 → 构建根目录缓存 → 加载初始数据 → 渲染可视化
```

### 2. 用户交互流程
```
用户点击目录 → 请求子目录数据 → 后端扫描 → 返回文件列表 → 更新可视化
```

### 3. 错误处理流程
```
操作失败 → 捕获错误 → 记录日志 → 显示用户友好错误信息 → 提供恢复选项
```

## 性能优化策略

### 1. 并行处理
- 使用 Rust `rayon` crate 实现数据并行
- 多线程目录扫描
- 工作窃取算法优化

### 2. 缓存机制
- 内存缓存避免重复扫描
- 智能缓存失效策略
- 增量更新支持

### 3. 前端优化
- 虚拟化长列表
- 防抖和节流
- 增量渲染

## 安全考虑

### 1. 权限控制
- 最小权限原则
- 用户授权确认
- 安全路径验证

### 2. 错误处理
- 输入验证
- 异常捕获
- 安全日志记录

### 3. 系统保护
- 系统目录过滤
- 符号链接处理
- 循环引用检测

## 扩展性设计

### 1. 模块化架构
- 清晰的模块边界
- 依赖注入
- 插件化支持

### 2. 配置驱动
- 可配置扫描策略
- 主题和样式定制
- 性能参数调整

### 3. 跨平台支持
- 抽象平台差异
- 统一接口设计
- 条件编译支持